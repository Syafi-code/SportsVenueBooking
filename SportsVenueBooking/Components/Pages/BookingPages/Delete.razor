@page "/bookings/delete"
@using Microsoft.EntityFrameworkCore
@using SportsVenueBooking.Domain
@inject IDbContextFactory<SportsVenueBooking.Data.SportsVenueBookingContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Cancel Booking</PageTitle>

<h1>Cancel Booking</h1>
<hr />

<div class="alert alert-warning" role="alert">
    <strong>Warning!</strong> Are you sure you want to cancel this booking?
</div>

@if (booking is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Booking Details</h5>
            <dl class="row">
                <dt class="col-sm-3">Venue:</dt>
                <dd class="col-sm-9">@VenueName</dd>

                <dt class="col-sm-3">Booking Date:</dt>
                <dd class="col-sm-9">@booking.BookingDate.ToString("dddd, MMMM dd, yyyy")</dd>

                <dt class="col-sm-3">Start Time:</dt>
                <dd class="col-sm-9">@booking.StartTime.ToString("hh:mm tt")</dd>

                <dt class="col-sm-3">End Time:</dt>
                <dd class="col-sm-9">@booking.EndTime.ToString("hh:mm tt")</dd>

                <dt class="col-sm-3">Status:</dt>
                <dd class="col-sm-9">
                    <span class="badge bg-success">@booking.Status</span>
                </dd>

                @if (!string.IsNullOrEmpty(booking.SpecialRequests))
                {
                    <dt class="col-sm-3">Special Requests:</dt>
                    <dd class="col-sm-9">@booking.SpecialRequests</dd>
                }
            </dl>
        </div>
    </div>

    <EditForm method="post" Model="booking" OnValidSubmit="DeleteBooking" FormName="delete" Enhance>
        <div class="mt-3">
            <button type="submit" class="btn btn-danger">Yes, Cancel This Booking</button>
            <a href="/bookings" class="btn btn-secondary">No, Keep Booking</a>
        </div>
    </EditForm>
}

@code {
    private Booking? booking;
    private string? VenueName;

    [SupplyParameterFromQuery]
    private int Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        booking = await context.Booking.FirstOrDefaultAsync(m => m.Id == Id);

        if (booking is null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        // Get venue name
        var venue = await context.Venue.FirstOrDefaultAsync(v => v.Id == booking.VenueID);
        VenueName = venue?.VenueName ?? "Unknown Venue";
    }

    private async Task DeleteBooking()
    {
        using var context = DbFactory.CreateDbContext();

        // Change status to "Cancelled" instead of deleting
        booking!.Status = "Cancelled";
        booking.DateUpdated = DateTime.Now;

        context.Attach(booking).State = EntityState.Modified;
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/bookings");
    }
}