@page "/bookings/edit"
@using Microsoft.EntityFrameworkCore
@using SportsVenueBooking.Domain
@inject IDbContextFactory<SportsVenueBooking.Data.SportsVenueBookingContext> DbFactory
@inject NavigationManager NavigationManager
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@attribute [Authorize(Roles = "Student,Administrator")]
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Edit Booking</PageTitle>

<h1>Edit Booking</h1>
<hr />

@if (Booking is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row">
        <div class="col-md-6">
            <EditForm method="post" Model="Booking" OnValidSubmit="UpdateBooking" FormName="edit" Enhance>
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" role="alert" />
                <input type="hidden" name="Booking.Id" value="@Booking.Id" />

                <div class="mb-3">
                    <label for="venueid" class="form-label">Venue:</label>
                    <InputSelect id="venueid" @bind-Value="Booking.VenueID" class="form-select">
                        @foreach (var venue in Venues)
                        {
                            <option value="@venue.Id">@venue.VenueName (@venue.VenueType)</option>
                        }
                    </InputSelect>
                </div>

                <div class="mb-3">
                    <label for="bookingdate" class="form-label">Booking Date:</label>
                    <InputDate id="bookingdate" @bind-Value="Booking.BookingDate" class="form-control" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                </div>

                <div class="mb-3">
                    <label for="starttime" class="form-label">Start Time:</label>
                    <InputSelect id="starttime" @bind-Value="SelectedStartTime" class="form-select">
                        <option value="">-- Select Start Time --</option>
                        <option value="09:00">9:00 AM</option>
                        <option value="10:00">10:00 AM</option>
                        <option value="11:00">11:00 AM</option>
                        <option value="12:00">12:00 PM</option>
                        <option value="13:00">1:00 PM</option>
                        <option value="14:00">2:00 PM</option>
                        <option value="15:00">3:00 PM</option>
                        <option value="16:00">4:00 PM</option>
                        <option value="17:00">5:00 PM</option>
                        <option value="18:00">6:00 PM</option>
                        <option value="19:00">7:00 PM</option>
                        <option value="20:00">8:00 PM</option>
                    </InputSelect>
                </div>

                <div class="mb-3">
                    <label for="duration" class="form-label">Duration:</label>
                    <InputSelect id="duration" @bind-Value="Duration" class="form-select">
                        <option value="1">1 Hour</option>
                        <option value="2">2 Hours</option>
                    </InputSelect>
                </div>

                <div class="mb-3">
                    <label for="specialrequests" class="form-label">Special Requests:</label>
                    <InputTextArea id="specialrequests" @bind-Value="Booking.SpecialRequests" class="form-control" rows="3" />
                </div>

                <button type="submit" class="btn btn-primary">Save Changes</button>
                <a href="/bookings" class="btn btn-secondary">Cancel</a>
            </EditForm>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    [SupplyParameterFromForm]
    private Booking? Booking { get; set; }

    private List<Venue> Venues { get; set; } = new();
    private string SelectedStartTime { get; set; } = "";
    private int Duration { get; set; } = 1;
    private string? ErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        Booking ??= await context.Booking.FirstOrDefaultAsync(m => m.Id == Id);

        if (Booking is null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        // Get current user's school ID
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        int? userSchoolID = null;
        if (!string.IsNullOrEmpty(userId))
        {
            var appUser = await context.Users.FirstOrDefaultAsync(u => u.Id == userId);
            userSchoolID = appUser?.SchoolId;
        }

        // Load venues - filter by user's school if student
        if (user.IsInRole("Administrator"))
        {
            // Admins can edit to any venue
            Venues = await context.Venue
                .Where(v => v.IsAvailable == true)
                .OrderBy(v => v.VenueName)
                .ToListAsync();
        }
        else if (userSchoolID.HasValue)
        {
            // Students can only change to venues from their school
            Venues = await context.Venue
                .Where(v => v.IsAvailable == true && v.SchoolID == userSchoolID.Value)
                .OrderBy(v => v.VenueName)
                .ToListAsync();
        }
        else
        {
            Venues = new List<Venue>();
        }

        // Calculate duration and start time from existing booking
        var duration = (Booking.EndTime - Booking.StartTime).TotalHours;
        Duration = (int)duration;

        SelectedStartTime = Booking.StartTime.ToString("HH:mm");
    }

    private async Task UpdateBooking()
    {
        ErrorMessage = null;

        // Validate venue selected
        if (Booking.VenueID == 0)
        {
            ErrorMessage = "Please select a venue.";
            return;
        }

        // Validate start time selected
        if (string.IsNullOrEmpty(SelectedStartTime))
        {
            ErrorMessage = "Please select a start time.";
            return;
        }

        using var context = DbFactory.CreateDbContext();

        // Convert start time string to DateTime
        var timeParts = SelectedStartTime.Split(':');
        var startHour = int.Parse(timeParts[0]);
        var startMinute = int.Parse(timeParts[1]);

        // Set start and end times
        Booking.StartTime = Booking.BookingDate.AddHours(startHour).AddMinutes(startMinute);
        Booking.EndTime = Booking.StartTime.AddHours(Duration);

        // Update timestamp
        Booking.DateUpdated = DateTime.Now;

        context.Attach(Booking!).State = EntityState.Modified;

        try
        {
            await context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!BookingExists(Booking!.Id))
            {
                NavigationManager.NavigateTo("notfound");
            }
            else
            {
                throw;
            }
        }

        NavigationManager.NavigateTo("/bookings");
    }

    private bool BookingExists(int id)
    {
        using var context = DbFactory.CreateDbContext();
        return context.Booking.Any(e => e.Id == id);
    }
}