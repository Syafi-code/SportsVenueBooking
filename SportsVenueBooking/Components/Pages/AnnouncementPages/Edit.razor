@page "/announcements/edit"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using SportsVenueBooking.Domain
@inject IDbContextFactory<SportsVenueBooking.Data.SportsVenueBookingContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Edit Announcement</PageTitle>

<h1>Edit Announcement</h1>
<hr />

@if (Announcement == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Title</label>
                <input type="text" @bind="Announcement.Title" @bind:event="oninput" class="form-control" />
            </div>

            <div class="mb-3">
                <label class="form-label">Message</label>
                <textarea @bind="Announcement.Message" @bind:event="oninput" class="form-control" rows="5"></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">Active Status</label>
                <div class="form-check">
                    <input type="checkbox" @bind="Announcement.IsActive" class="form-check-input" id="isActive" />
                    <label class="form-check-label" for="isActive">
                        Make this announcement active (visible to students)
                    </label>
                </div>
            </div>

            <button @onclick="UpdateAnnouncement" class="btn btn-primary">Save Changes</button>
            <a href="/announcements" class="btn btn-secondary">Back to List</a>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    private Announcement? Announcement;

    protected override async Task OnInitializedAsync()
    {
        using var context = await DbFactory.CreateDbContextAsync();

        Announcement = await context.Announcement.FirstOrDefaultAsync(a => a.Id == Id);

        if (Announcement == null)
        {
            NavigationManager.NavigateTo("/announcements");
        }
    }

    private async Task UpdateAnnouncement()
    {
        if (Announcement == null) return;

        using var context = await DbFactory.CreateDbContextAsync();

        // Load existing announcement
        var existingAnnouncement = await context.Announcement.FindAsync(Id);

        if (existingAnnouncement == null)
        {
            NavigationManager.NavigateTo("/announcements");
            return;
        }

        // Update properties
        existingAnnouncement.Title = Announcement.Title;
        existingAnnouncement.Message = Announcement.Message;
        existingAnnouncement.IsActive = Announcement.IsActive;
        existingAnnouncement.DateUpdated = DateTime.Now;

        await context.SaveChangesAsync();

        NavigationManager.NavigateTo("/announcements");
    }
}