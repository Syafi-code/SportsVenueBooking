@page "/venues/edit"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using SportsVenueBooking.Domain
@attribute [Authorize(Roles = "Administrator")]
@inject IDbContextFactory<SportsVenueBooking.Data.SportsVenueBookingContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Edit Venue</PageTitle>

<h1>Edit Venue</h1>
<hr />

@if (Venue == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <EditForm Model="Venue" OnValidSubmit="UpdateVenue" FormName="edit" Enhance>
                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger" />

                        <input type="hidden" @bind="Venue.Id" />

                        <!-- VENUE NAME -->
                        <div class="mb-3">
                            <label for="venuename" class="form-label">Venue Name</label>
                            <InputText id="venuename" @bind-Value="Venue.VenueName" class="form-control" />
                            <ValidationMessage For="() => Venue.VenueName" class="text-danger" />
                        </div>

                        <!-- VENUE TYPE -->
                        <div class="mb-3">
                            <label for="venuetype" class="form-label">Venue Type</label>
                            <InputSelect id="venuetype" @bind-Value="Venue.VenueType" class="form-select">
                                <option value="">-- Select Type --</option>
                                <option value="Basketball">Basketball</option>
                                <option value="Football">Football</option>
                                <option value="Swimming">Swimming</option>
                                <option value="Badminton">Badminton</option>
                                <option value="Tennis">Tennis</option>
                                <option value="Gym">Gym</option>
                            </InputSelect>
                            <ValidationMessage For="() => Venue.VenueType" class="text-danger" />
                        </div>

                        <!-- CAPACITY -->
                        <div class="mb-3">
                            <label for="capacity" class="form-label">Capacity</label>
                            <InputNumber id="capacity" @bind-Value="Venue.Capacity" class="form-control" />
                            <ValidationMessage For="() => Venue.Capacity" class="text-danger" />
                        </div>

                        <!-- SCHOOL -->
                        <div class="mb-3">
                            <label for="school" class="form-label">School</label>
                            <InputSelect id="school" @bind-Value="Venue.SchoolID" class="form-select">
                                <option value="0">-- Select School --</option>
                                @foreach (var school in Schools)
                                {
                                    <option value="@school.Id">@school.SchoolName</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="() => Venue.SchoolID" class="text-danger" />
                        </div>

                        <!-- IS AVAILABLE -->
                        <div class="mb-3 form-check">
                            <InputCheckbox id="isavailable" @bind-Value="Venue.IsAvailable" class="form-check-input" />
                            <label for="isavailable" class="form-check-label">Is Available</label>
                        </div>

                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <a href="/venues" class="btn btn-secondary">Cancel</a>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    [SupplyParameterFromForm]
    private Domain.Venue? Venue { get; set; }

    private List<School> Schools = new();

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        Venue ??= await context.Venue.FirstOrDefaultAsync(m => m.Id == Id);

        if (Venue == null)
        {
            NavigationManager.NavigateTo("/venues");
            return;
        }

        // Load schools for dropdown
        Schools = await context.Schools.ToListAsync();
    }

    private async Task UpdateVenue()
    {
        using var context = DbFactory.CreateDbContext();

        context.Attach(Venue!).State = EntityState.Modified;

        try
        {
            await context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!await VenueExists(Venue!.Id))
            {
                NavigationManager.NavigateTo("/venues");
                return;
            }
            else
            {
                throw;
            }
        }

        NavigationManager.NavigateTo("/venues");
    }

    private async Task<bool> VenueExists(int id)
    {
        using var context = DbFactory.CreateDbContext();
        return await context.Venue.AnyAsync(e => e.Id == id);
    }
}