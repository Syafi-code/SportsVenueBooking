@page "/venues/edit"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using SportsVenueBooking.Domain
@attribute [Authorize(Roles = "Administrator")]
@inject IDbContextFactory<SportsVenueBooking.Data.SportsVenueBookingContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Edit Venue</PageTitle>

<h1>Edit Venue</h1>
<hr />

@if (Venue == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <!-- VENUE NAME -->
                    <div class="mb-3">
                        <label class="form-label">Venue Name</label>
                        <input type="text" @bind="Venue.VenueName" @bind:event="oninput" class="form-control" />
                    </div>

                    <!-- VENUE TYPE -->
                    <div class="mb-3">
                        <label class="form-label">Venue Type</label>
                        <select @bind="Venue.VenueType" class="form-select">
                            <option value="">-- Select Type --</option>
                            <option value="Basketball">Basketball</option>
                            <option value="Football">Football</option>
                            <option value="Swimming">Swimming</option>
                            <option value="Badminton">Badminton</option>
                            <option value="Tennis">Tennis</option>
                            <option value="Gym">Gym</option>
                        </select>
                    </div>

                    <!-- CAPACITY -->
                    <div class="mb-3">
                        <label class="form-label">Capacity</label>
                        <input type="number" @bind="Venue.Capacity" @bind:event="oninput" class="form-control" />
                    </div>

                    <!-- SCHOOL -->
                    <div class="mb-3">
                        <label class="form-label">School</label>
                        <select @bind="Venue.SchoolID" class="form-select">
                            <option value="0">-- Select School --</option>
                            @foreach (var school in Schools)
                            {
                                <option value="@school.Id">@school.SchoolName</option>
                            }
                        </select>
                    </div>

                    <!-- IS AVAILABLE -->
                    <div class="mb-3 form-check">
                        <input type="checkbox" @bind="Venue.IsAvailable" class="form-check-input" id="isavailable" />
                        <label class="form-check-label" for="isavailable">Is Available</label>
                    </div>

                    <button @onclick="UpdateVenue" class="btn btn-primary">Save Changes</button>
                    <a href="/venues" class="btn btn-secondary">Cancel</a>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    private Venue? Venue { get; set; }
    private List<School> Schools = new();

    protected override async Task OnInitializedAsync()
    {
        using var context = await DbFactory.CreateDbContextAsync();

        Venue = await context.Venue.FirstOrDefaultAsync(m => m.Id == Id);

        if (Venue is null)
        {
            NavigationManager.NavigateTo("/venues");
            return;
        }

        Schools = await context.Schools.ToListAsync();
    }

    private async Task UpdateVenue()
    {
        if (Venue is null) return;

        using var context = await DbFactory.CreateDbContextAsync();

        var existingVenue = await context.Venue.FindAsync(Id);

        if (existingVenue is null)
        {
            NavigationManager.NavigateTo("/venues");
            return;
        }

        existingVenue.VenueName = Venue.VenueName;
        existingVenue.VenueType = Venue.VenueType;
        existingVenue.Capacity = Venue.Capacity;
        existingVenue.SchoolID = Venue.SchoolID;
        existingVenue.IsAvailable = Venue.IsAvailable;
        existingVenue.DateUpdated = DateTime.Now;

        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/venues");
    }
}