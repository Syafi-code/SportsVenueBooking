@page "/venues"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using SportsVenueBooking.Domain
@using SportsVenueBooking.Data
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@implements IAsyncDisposable
@inject IDbContextFactory<SportsVenueBooking.Data.SportsVenueBookingContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Browse Venues</PageTitle>

<h1>Available Venues</h1>

<AuthorizeView Roles="Administrator">
    <Authorized>
        <p>
            <a href="venues/create" class="btn btn-primary">Create New Venue</a>
        </p>
    </Authorized>
</AuthorizeView>

<QuickGrid Class="table table-striped" Items="FilteredVenues">
    <PropertyColumn Property="venue => venue.VenueName" Title="Venue Name" />
    <PropertyColumn Property="venue => venue.VenueType" Title="Type" />
    <PropertyColumn Property="venue => venue.OpeningHours" Title="Opening Hours" />

    <TemplateColumn Title="Capacity">
        @{
            var slotsLeft = GetAvailableSlots(context);
            var totalCapacity = context.Capacity;
        }
        @totalCapacity
        @if (slotsLeft > 0)
        {
            <span class="text-success"> (@slotsLeft slots left!)</span>
        }
        else
        {
            <span class="text-danger"> (FULL)</span>
        }
    </TemplateColumn>
    
    <TemplateColumn Title="School">
        @GetSchoolName(context)
    </TemplateColumn>

    <TemplateColumn Title="Available">
        @if (context.IsAvailable)
        {
            <span class="badge bg-success">Available</span>
        }
        else
        {
            <span class="badge bg-danger">Not Available</span>
        }
    </TemplateColumn>

    <TemplateColumn Context="venue" Title="Actions">
        <AuthorizeView Roles="Administrator">
            <Authorized>
                <a href="@($"venues/edit?id={venue.Id}")" class="btn btn-sm btn-warning">Edit</a>
                <a href="@($"venues/delete?id={venue.Id}")" class="btn btn-sm btn-danger">Delete</a>
            </Authorized>
        </AuthorizeView>

        <AuthorizeView Roles="Student">
            <Authorized>
                @if (venue.IsAvailable)
                {
                    <a href="@($"/bookings/create?venueId={venue.Id}")" class="btn btn-sm btn-primary">Book Now</a>
                }
            </Authorized>
        </AuthorizeView>

        <a href="@($"venues/details?id={venue.Id}")" class="btn btn-sm btn-info">Details</a>
    </TemplateColumn>
</QuickGrid>

@code {
    private SportsVenueBookingContext context = default!;
    private IQueryable<Venue>? FilteredVenues;
    private Dictionary<int, string> SchoolNames = new();

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();

        // Load school names
        var schools = await context.Schools.ToListAsync();
        SchoolNames = schools.ToDictionary(s => s.Id, s => s.SchoolName ?? "Unknown");

        // Get current user information
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        // Get user ID
        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        // Get user's school ID
        int? userSchoolID = null;
        if (!string.IsNullOrEmpty(userId))
        {
            var appUser = await context.Users.FirstOrDefaultAsync(u => u.Id == userId);
            userSchoolID = appUser?.SchoolID;
        }

        // Filter venues based on role
        if (user.IsInRole("Administrator"))
        {
            // Admins see ALL venues from all schools
            FilteredVenues = context.Venue
                .OrderBy(v => v.SchoolID)
                .ThenBy(v => v.VenueName)
                .AsQueryable();
        }
        else if (userSchoolID.HasValue)
        {
            // Students see only venues from their school that have slots available
            var studentVenues = context.Venue
                .Where(v => v.SchoolID == userSchoolID.Value)
                .ToList();

            // Filter out full venues
            var availableVenues = studentVenues
                .Where(v => GetAvailableSlots(v) > 0)
                .AsQueryable();

            FilteredVenues = availableVenues;
        }
        else
        {
            // Not logged in - show all venues (but can't book)
            FilteredVenues = context.Venue
                .OrderBy(v => v.SchoolID)
                .ThenBy(v => v.VenueName)
                .AsQueryable();
        }
    }

    private string GetSchoolName(Venue venue)
    {
        return SchoolNames.TryGetValue(venue.SchoolID, out var name) ? name : "Unknown";
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();

    private int GetAvailableSlots(Venue venue)
    {
        // Count how many people have bookings for this venue today (confirmed bookings only)
        var bookedSlots = context.Booking
            .Where(b => b.VenueID == venue.Id)
            .Where(b => b.Status == "Confirmed")
            .Where(b => b.BookingDate == DateTime.Today)
            .Count();

        return venue.Capacity - bookedSlots;
    }
}