@page "/venues/delete"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using SportsVenueBooking.Domain
@attribute [Authorize(Roles = "Administrator")]
@inject IDbContextFactory<SportsVenueBooking.Data.SportsVenueBookingContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Delete Venue</PageTitle>

<h1>Delete Venue</h1>
<p class="text-danger">Are you sure you want to delete this venue?</p>

@if (Venue == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="card">
        <div class="card-header bg-danger text-white">
            <h3 class="mb-0">Venue Details</h3>
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Venue Name:</dt>
                <dd class="col-sm-9">@Venue.VenueName</dd>

                <dt class="col-sm-3">Type:</dt>
                <dd class="col-sm-9">@Venue.VenueType</dd>

                <dt class="col-sm-3">Capacity:</dt>
                <dd class="col-sm-9">@Venue.Capacity people</dd>

                <dt class="col-sm-3">School:</dt>
                <dd class="col-sm-9">@SchoolName</dd>

                <dt class="col-sm-3">Available:</dt>
                <dd class="col-sm-9">
                    @if (Venue.IsAvailable)
                    {
                        <span class="badge bg-success">Yes</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary">No</span>
                    }
                </dd>
            </dl>

            <EditForm Model="Venue" OnValidSubmit="DeleteVenue" FormName="delete" Enhance>
                <button type="submit" class="btn btn-danger">Delete Venue</button>
                <a href="/venues" class="btn btn-secondary">Cancel</a>
            </EditForm>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    [SupplyParameterFromForm]
    private Domain.Venue? Venue { get; set; }

    private string SchoolName = "";

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        Venue ??= await context.Venue.FirstOrDefaultAsync(m => m.Id == Id);

        if (Venue == null)
        {
            NavigationManager.NavigateTo("/venues");
            return;
        }

        // Load school name
        var school = await context.Schools.FirstOrDefaultAsync(s => s.Id == Venue.SchoolID);
        SchoolName = school?.SchoolName ?? "Unknown";
    }

    private async Task DeleteVenue()
    {
        using var context = DbFactory.CreateDbContext();

        var venue = await context.Venue.FindAsync(Id);

        if (venue != null)
        {
            context.Venue.Remove(venue);
            await context.SaveChangesAsync();
        }

        NavigationManager.NavigateTo("/venues");
    }
}