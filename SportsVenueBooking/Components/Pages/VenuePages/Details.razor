@page "/venues/details"
@using Microsoft.EntityFrameworkCore
@using SportsVenueBooking.Domain
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@inject IDbContextFactory<SportsVenueBooking.Data.SportsVenueBookingContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Venue Details</PageTitle>

<h1>Venue Details</h1>
<hr />

@if (Venue == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <!-- VENUE INFO CARD -->
    <div class="card mb-4">
        <div class="card-header">
            <h3>@Venue.VenueName</h3>
        </div>
        <div class="card-body">
            <p><strong>Type:</strong> <span class="badge bg-primary">@Venue.VenueType</span></p>
            <p><strong>School:</strong> @SchoolName</p>
            <p><strong>Capacity:</strong> @Venue.Capacity people</p>
            <p><strong>Opening Hours:</strong> @Venue.OpeningHours</p>

            @if (Venue.IsAvailable)
            {
                <span class="badge bg-success">Available</span>
            }
            else
            {
                <span class="badge bg-danger">Not Available</span>
            }

            <hr />

            <!-- BUTTONS -->
            <AuthorizeView Roles="Student">
                <Authorized>
                    @if (Venue.IsAvailable)
                    {
                        <a href="@($"/bookings/create?venueId={Venue.Id}")" class="btn btn-primary">Book This Venue</a>
                    }
                </Authorized>
            </AuthorizeView>

            <AuthorizeView Roles="Administrator">
                <Authorized>
                    <a href="@($"/venues/edit?id={Venue.Id}")" class="btn btn-warning">Edit</a>
                    <a href="@($"/venues/delete?id={Venue.Id}")" class="btn btn-danger">Delete</a>
                </Authorized>
            </AuthorizeView>

            <a href="/venues" class="btn btn-secondary">Back to List</a>
        </div>
    </div>

    <!-- REVIEWS SECTION -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Reviews & Ratings</h4>
            <AuthorizeView Roles="Student">
                <Authorized>
                    @if (!UserAlreadyReviewed)
                    {
                        <a href="@($"/reviews/create?venueId={Venue.Id}")" class="btn btn-sm btn-primary">Write a Review</a>
                    }
                </Authorized>
            </AuthorizeView>
        </div>
        <div class="card-body">
            @if (Reviews.Count > 0)
            {
                <!-- AVERAGE RATING -->
                <div class="mb-4">
                    <h3 class="d-inline">@AverageRating.ToString("0.0")</h3>
                    <span class="ms-2">
                        @for (int i = 1; i <= 5; i++)
                        {
                            <span style="font-size: 1.5rem; color: @(i <= Math.Round(AverageRating) ? "#ffc107" : "#e4e5e9");">★</span>
                        }
                    </span>
                    <p class="text-muted">Based on @Reviews.Count review(s)</p>
                </div>

                <hr />

                <!-- LIST OF REVIEWS -->
                @foreach (var review in Reviews)
                {
                    <div class="mb-3 pb-3 border-bottom">
                        <!-- STARS -->
                        <div class="mb-2">
                            @for (int i = 1; i <= 5; i++)
                            {
                                <span style="color: @(i <= review.Rating ? "#ffc107" : "#e4e5e9"); font-size: 1.2rem;">★</span>
                            }
                            <span class="ms-2 text-muted small">@review.ReviewDate.ToString("MMM dd, yyyy")</span>
                        </div>

                        <!-- COMMENT -->
                        <p class="mb-1">@review.Comment</p>
                        <small class="text-muted">By: @GetUserEmail(review.UserID)</small>


                        <!-- EDIT/DELETE BUTTONS (only for your own reviews) -->
                        <AuthorizeView Roles="Student">
                            <Authorized>
                                @if (review.UserID == CurrentUserId)
                                {
                                    <div class="mt-2">
                                        <a href="@($"/reviews/edit?id={review.Id}")" class="btn btn-sm btn-warning">Edit</a>
                                        <a href="@($"/reviews/delete?id={review.Id}")" class="btn btn-sm btn-danger">Delete</a>
                                    </div>
                                }
                            </Authorized>
                        </AuthorizeView>
                    </div>
                }
            }
            else
            {
                <div class="alert alert-info">
                    No reviews yet. Be the first to review this venue!
                </div>
            }
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    // Variables to store data
    private Venue? Venue;
    private List<Review> Reviews = new();
    private string SchoolName = "";
    private Dictionary<string, string> UserEmails = new();
    private double AverageRating = 0;
    private bool UserAlreadyReviewed = false;
    private string? CurrentUserId;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        //Load the venue
        Venue = await context.Venue.FirstOrDefaultAsync(v => v.Id == Id);

        if (Venue == null)
        {
            NavigationManager.NavigateTo("/venues");
            return;
        }

        //Load school name
        var school = await context.Schools.FirstOrDefaultAsync(s => s.Id == Venue.SchoolID);
        SchoolName = school?.SchoolName ?? "Unknown";

        //Get current user ID
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        CurrentUserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        //Load reviews for this venue
        Reviews = await context.Review
            .Where(r => r.VenueID == Venue.Id)
            .OrderByDescending(r => r.ReviewDate)
            .ToListAsync();

        //Calculate average rating
        if (Reviews.Count > 0)
        {
            AverageRating = Reviews.Average(r => r.Rating);
        }

        //Load user emails for reviews
        var userIds = Reviews.Select(r => r.UserID).Distinct().ToList();
        var users = await context.Users
            .Where(u => userIds.Contains(u.Id))
            .ToListAsync();
        UserEmails = users.ToDictionary(u => u.Id, u => u.Email ?? "Anonymous");

        //Check if current user already reviewed
        if (!string.IsNullOrEmpty(CurrentUserId))
        {
            UserAlreadyReviewed = await context.Review
                .AnyAsync(r => r.VenueID == Id && r.UserID == CurrentUserId);
        }
    }

    private string GetUserEmail(string? userId)
    {
        if (string.IsNullOrEmpty(userId)) return "Anonymous";
        return UserEmails.TryGetValue(userId, out var email) ? email : "Anonymous";
    }
}