@page "/reviews/delete"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using SportsVenueBooking.Domain
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@attribute [Authorize]
@inject IDbContextFactory<SportsVenueBooking.Data.SportsVenueBookingContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Delete Review</PageTitle>

<h1>Delete Review</h1>
<h3 class="text-danger">Are you sure you want to delete this review?</h3>
<hr />

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">@ErrorMessage</div>
}

@if (Review == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="card mb-3">
        <div class="card-body">
            <h5>@VenueName</h5>

            <!-- Star Rating -->
            <div class="mb-2">
                @for (int i = 1; i <= 5; i++)
                {
                    <span style="color: @(i <= Review.Rating ? "#ffc107" : "#e4e5e9"); font-size: 1.5rem;">★</span>
                }
                <span class="ms-2">(@Review.Rating/5 stars)</span>
            </div>

            <p class="text-muted small">Reviewed on: @Review.ReviewDate.ToString("MMMM dd, yyyy")</p>
            <p>@Review.Comment</p>

            @if (!string.IsNullOrEmpty(Review.UserID))
            {
                <p class="text-muted small">By: @Review.UserID</p>
            }
        </div>
    </div>

    <button @onclick="DeleteReview" class="btn btn-danger">Yes, Delete This Review</button>
    <a href="/admin/dashboard" class="btn btn-secondary">Cancel</a>
}

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    private Review? Review;
    private string? VenueName;
    private string? ErrorMessage;
    private string? CurrentUserId;
    private bool IsAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        using var context = await DbFactory.CreateDbContextAsync();

        // Get current user
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        CurrentUserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        IsAdmin = user.IsInRole("Administrator");

        // Load the review
        Review = await context.Review.FirstOrDefaultAsync(r => r.Id == Id);

        if (Review == null)
        {
            NavigationManager.NavigateTo("/admin/dashboard");
            return;
        }

        // Allow admins to delete any review, students only their own
        if (!IsAdmin && Review.UserID != CurrentUserId)
        {
            ErrorMessage = "You can only delete your own reviews!";
            return;
        }

        // Load venue name
        var venue = await context.Venue.FirstOrDefaultAsync(v => v.Id == Review.VenueID);
        VenueName = venue?.VenueName ?? "Unknown Venue";
    }

    private async Task DeleteReview()
    {
        if (Review == null) return;

        using var context = await DbFactory.CreateDbContextAsync();

        var reviewToDelete = await context.Review.FindAsync(Id);

        if (reviewToDelete != null)
        {
            context.Review.Remove(reviewToDelete);
            await context.SaveChangesAsync();
        }

        NavigationManager.NavigateTo("/admin/dashboard");
    }
}