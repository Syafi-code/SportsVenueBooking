@page "/reviews/details"
@using Microsoft.EntityFrameworkCore
@using SportsVenueBooking.Domain
@inject IDbContextFactory<SportsVenueBooking.Data.SportsVenueBookingContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Review Details</PageTitle>

<h1>Review Details</h1>
<hr />

@if (review == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="card">
        <div class="card-header">
            <h4>@VenueName</h4>
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Rating:</dt>
                <dd class="col-sm-9">
                    @for (int i = 1; i <= 5; i++)
                    {
                        <span style="font-size: 1.5rem; color: @(i <= review.Rating ? "#ffc107" : "#e4e5e9");">★</span>
                    }
                    <span class="ms-2">(@review.Rating out of 5)</span>
                </dd>

                <dt class="col-sm-3">Review:</dt>
                <dd class="col-sm-9">@review.Comment</dd>

                <dt class="col-sm-3">Reviewed By:</dt>
                <dd class="col-sm-9">@UserEmail</dd>

                <dt class="col-sm-3">Review Date:</dt>
                <dd class="col-sm-9">@review.ReviewDate.ToString("dddd, MMMM dd, yyyy")</dd>

                <dt class="col-sm-3">Status:</dt>
                <dd class="col-sm-9">
                    @if (review.IsApproved)
                    {
                        <span class="badge bg-success">Approved</span>
                    }
                    else
                    {
                        <span class="badge bg-warning">Pending Approval</span>
                    }
                </dd>

                @if (!string.IsNullOrEmpty(review.AdminResponse))
                {
                    <dt class="col-sm-3">Admin Response:</dt>
                    <dd class="col-sm-9">
                        <div class="p-3 bg-light rounded">
                            @review.AdminResponse
                        </div>
                    </dd>
                }
            </dl>
        </div>
    </div>

    <div class="mt-3">
        <a href="@($"/reviews?venueId={review.VenueID}")" class="btn btn-secondary">Back to Reviews</a>
        <a href="@($"/venues/details?id={review.VenueID}")" class="btn btn-info">View Venue</a>
    </div>
}

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    private Review? review;
    private string? VenueName;
    private string? UserEmail;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        
        review = await context.Review.FirstOrDefaultAsync(r => r.Id == Id);

        if (review == null)
        {
            NavigationManager.NavigateTo("/venues");
            return;
        }

        // Get venue name
        var venue = await context.Venue.FirstOrDefaultAsync(v => v.Id == review.VenueID);
        VenueName = venue?.VenueName ?? "Unknown Venue";

        // Get user email
        var user = await context.Users.FirstOrDefaultAsync(u => u.Id == review.UserID);
        UserEmail = user?.Email ?? "Anonymous";
    }
}